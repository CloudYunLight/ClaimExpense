# 报销跟踪系统设计方案

## 一、 核心需求调整与明确
1.  **管理员权限精简**：仅负责用户账户管理（新增用户、密码重置、账户状态启停），不参与报销清单/账单的业务操作。
2.  **用户数据隔离**：每个用户仅能查看、操作**自己创建**的报销清单。
3.  **新增大盘可视化功能**：按统计清单数量、各报销状态占比、金额汇总等数据，支持多维度筛选。
4.  **技术栈适配AI编程**：采用 Ant Design Pro (前端) + Node.js (后端) + MySQL (数据库) 的技术组合。

## 二、 数据库表结构设计（MySQL）
### 1. 用户表 `users`
| 字段名        | 数据类型         | 说明                     | 约束条件                  |
|---------------|------------------|--------------------------|---------------------------|
| `user_id`     | INT              | 用户唯一ID               | PRIMARY KEY, AUTO_INCREMENT |
| `username`    | VARCHAR(50)      | 用户名（登录用）| NOT NULL, UNIQUE          |
| `password`    | VARCHAR(100)     | 密码（BCrypt加密存储）| NOT NULL                  |
| `real_name`   | VARCHAR(50)      | 真实姓名                 | NOT NULL                  |
| `role`        | INT              | 角色（1=admin/0=user）| DEFAULT 0                 |
| `status`      | INT              | 账户状态（1=normal/0=locked）| DEFAULT 1          |
| `create_time` | DATETIME         | 账号创建时间             | DEFAULT CURRENT_TIMESTAMP |

### 2. 报销清单表 `reimbursement_lists`
| 字段名            | 数据类型         | 说明                     | 约束条件                  |
|-------------------|------------------|--------------------------|---------------------------|
| `list_id`         | INT              | 清单唯一ID               | PRIMARY KEY, AUTO_INCREMENT |
| `activity_name`   | VARCHAR(100)     | 活动名称                 | NOT NULL                  |
| `creator_id`      | INT              | 清单创建人ID             | NOT NULL, FOREIGN KEY REFERENCES users(user_id) |
| `total_amount`    | DECIMAL(12,2)    | 账单总金额               | NOT NULL, DEFAULT 0.00    |
| `status`          | INT              | 报销状态(0='未报销',1='已上交文件',2='已回款') | NOT NULL |
| `create_time`     | DATETIME         | 清单创建时间             | DEFAULT CURRENT_TIMESTAMP |
| `update_time`     | DATETIME         | 状态更新时间             | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP |

### 3. 账单表 `bills`
| 字段名            | 数据类型         | 说明                     | 约束条件                  |
|-------------------|------------------|--------------------------|---------------------------|
| `bill_id`         | INT              | 账单唯一ID               | PRIMARY KEY, AUTO_INCREMENT |
| `list_id`         | INT              | 关联清单ID               | NOT NULL, FOREIGN KEY REFERENCES reimbursement_lists(list_id) ON DELETE CASCADE |
| `payment_method`  | INT              | 支付方式（0=微信/1=支付宝/2=现金/3=需要转交）| NOT NULL |
| `amount`          | DECIMAL(10,2)    | 金额                     | NOT NULL, CHECK (amount > 0) |
| `payer_id`        | INT              | 支付人ID                 | NOT NULL, FOREIGN KEY REFERENCES users(user_id) |
| `create_time`     | DATETIME         | 账单创建时间             | DEFAULT CURRENT_TIMESTAMP |
| `remark`          | VARCHAR(200)     | 账单备注（可选，如发票号）| NULL                      |

## 三、 核心功能模块设计
### 1. 管理员专属模块
1. **用户列表查询**：支持按用户名、真实姓名、状态筛选。
2. **用户新增**：录入用户名、真实姓名，设置初始密码（系统生成或指定），角色固定为user，状态为normal。
3. **密码重置**：将指定用户的密码重置为随机值并显示，系统提示用户首次登录后修改。
4. **账户启停**：将异常账户状态改为locked（锁定），或将被锁定账户改为normal（解锁）。

### 2. 普通用户核心业务模块
#### （1）报销清单管理
- **创建清单**：填写活动名称、清单创建人自动填充为当前用户，初始状态为**未报销**。
- **清单查询**：默认展示当前用户创建的所有清单，支持按报销状态、创建时间范围筛选，支持活动名称关键词搜索。
- **状态更新**：仅清单创建人可修改报销状态（未报销→已上交文件→已回款），更新后自动记录`update_time`。
- **清单删除**：仅创建人可删除，删除时级联删除关联账单，需二次确认。

#### （2）账单管理
- **添加账单**：选择当前用户创建的清单，填写支付方式、金额，支付人默认当前用户。
- **账单编辑/删除**：仅账单支付人可操作，修改后实时同步到清单的金额汇总。
- **清单详情查看**：进入清单详情页，展示清单基本信息、关联账单明细列表、账单总金额。

### 3. 数据可视化大盘模块
- **统计图表**：
  - 各报销状态（未报销/已上交文件/已回款）的占比
  - 金额汇总统计
- **筛选功能**：支持按时间范围（近7天/近30天/自定义）等多维度筛选统计数据

### 4. 权限控制模块（强化版）
| 操作主体 | 权限范围 |
|----------|----------|
| **管理员 (admin)** | 仅能操作 `users` 表，无法查看、操作任何 `reimbursement_lists` 和 `bills` 表数据 |
| **普通用户 (user)** | 仅能对**自己创建**的 `reimbursement_lists` 及其下的 `bills` 进行增、删、改、查。无法接触他人数据 |

## 四、 核心页面与交互流程
1. **登录页**：用户凭账号密码登录。
2. **用户首页（默认）**：
   - 显著位置提供"创建新清单"按钮。
   - 展示"待报销清单"列表（可筛选），条目显示：活动名称、创建时间、总金额。
   - 点击任一清单条目，进入该清单的**详情页**。
3. **清单详情页**：
   - 顶部展示清单基本信息（名称、类型、状态、总金额）。
   - 中部提供"添加账单"、"更新状态"等功能按钮。
   - 下部以表格形式展示该清单下的所有账单明细。
4. **数据大盘页**：通过导航菜单进入，展示用户的个人报销统计图表，支持动态筛选。
5. **管理员后台**：独立的用户管理界面，仅包含用户列表、新增、重置密码、启停账户功能。

## 五、 关键业务流程
1. **系统初始化**：由管理员创建各用户账户，并分配初始密码。
2. **首次登录**：用户使用初始密码登录，系统强制引导修改个人密码。
3. **报销流程**：
   - 用户**创建清单** → **添加账单**（可多次）→ 根据实际进度**更新清单状态**（如：文件已上交 → 款项已收到）。
4. **数据查看**：用户可随时在首页查看清单列表，或进入大盘页分析个人报销概况。





### **报销跟踪系统功能模块开发拆分表**

| **模块大类** | **子功能/页面** | **前端职责 (Ant Design Pro)** | **后端职责 (Node.js)** | **数据库操作 (MySQL)** | **关键技术点/注意** |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **A. 认证与授权** | **A1. 用户登录** | 1. 渲染登录表单。<br>2. 表单验证、密码加密（如md5）后提交。<br>3. 存储Token，跳转首页。 | 1. 验证用户名/密码。<br>2. 生成JWT Token。<br>3. 返回用户信息及Token。 | `SELECT` 查询 `users` 表，验证 `password` (需BCrypt对比)。 | 1. **JWT认证**。<br>2. 密码传输需加密，存储用BCrypt。<br>3. Token失效处理。 |
| | **A2. 登录拦截** | 1. 路由守卫，检查Token。<br>2. 无Token重定向到登录页。 | 1. 提供Token验证接口。<br>2. 大部分接口需附加Token校验中间件。 | - | **路由权限控制**。 |
| | **A3. 修改密码** | 1. 渲染修改密码表单（通常在个人设置或首次登录）。<br>2. 验证新旧密码，提交请求。 | 1. 验证原密码。<br>2. 对新密码进行BCrypt加密后更新。 | `UPDATE users SET password=? WHERE user_id=?` | 首次登录强制改密逻辑。 |
| **B. 管理员后台** | **B1. 用户列表** | 1. 表格展示用户列表。<br>2. 集成搜索（用户名、姓名）、筛选（状态）和分页。 | 1. 提供分页查询接口。<br>2. 处理搜索和筛选逻辑。 | `SELECT` 查询 `users` 表，`WHERE` 条件过滤。 | 管理员**数据隔离**：只返回用户表数据。 |
| | **B2. 新增用户** | 1. 弹窗表单，填写用户名、姓名。<br>2. 生成随机密码并展示。 | 1. 校验用户名唯一性。<br>2. 为密码生成BCrypt哈希值并入库。 | `INSERT INTO users (...)` | 密码明文仅在此刻由前端生成并显示一次。 |
| | **B3. 重置密码** | 1. 操作列按钮，点击后生成并展示新随机密码。 | 1. 接收用户ID，生成新密码哈希值并更新。 | `UPDATE users SET password=? WHERE user_id=?` | 同上，需记录日志。 |
| | **B4. 账户启停** | 1. 表格中显示状态开关，可点击切换。 | 1. 接收用户ID和新状态，更新账户状态字段。 | `UPDATE users SET status=? WHERE user_id=?` | 状态更新即时生效。 |
| **C. 用户核心业务** | **C1. 清单列表页** | 1. 展示“我的”报销清单表格。<br>2. “创建新清单”按钮。<br>3. 筛选（活动类型、状态、时间）和搜索（活动名称）。<br>4. 点击条目进入详情页。 | 1. 提供清单列表接口，**强制过滤 `creator_id = 当前用户ID`**。<br>2. 处理前端传入的筛选参数。 | `SELECT * FROM reimbursement_lists WHERE creator_id=? AND ...` | **核心数据隔离**的实现地。 |
| | **C2. 创建清单** | 1. 弹窗表单，填写活动名称。 | 1. 接收数据，自动填充 `creator_id`, `status=0`，创建清单。 | `INSERT INTO reimbursement_lists (...)` | 总金额 `total_amount` 初始为0。 |
| | **C3. 清单详情页** | 1. 展示清单基础信息卡片。<br>2. “更新状态”按钮。<br>3. “添加账单”按钮。<br>4. 下方展示关联的账单数据表格。 | 1. 提供清单详情接口（需校验创建人）。<br>2. 提供该清单下的账单列表接口。 | `SELECT * FROM reimbursement_lists WHERE list_id=?`<br>`SELECT * FROM bills WHERE list_id=?` | 进入页面需校验数据归属权。 |
| | **C4. 更新清单状态** | 1. 状态选择下拉框或步骤条。<br>2. 提交状态变更。 | 1. 校验操作人是清单创建人。<br>2. 更新 `status` 和 `update_time`。 | `UPDATE reimbursement_lists SET status=?, update_time=NOW() WHERE list_id=?` | `update_time` 自动更新。 |
| | **C5. 删除清单** | 1. 删除按钮，点击后二次确认。<br>2. 成功后刷新列表。 | 1. 校验操作人是清单创建人。<br>2. **级联删除**关联的所有账单（由数据库或代码逻辑实现）。 | `DELETE FROM reimbursement_lists WHERE list_id=?` | **需使用事务**，确保清单和账单删除的原子性。 |
| **D. 账单管理** | **D1. 添加账单** | 1. 弹窗表单，选择支付方式、填写金额、备注。<br>2. 支付人默认为当前用户（可考虑不允许修改）。 | 1. 关联到指定清单。<br>2. **更新所属清单的 `total_amount`**（`原总额 + 新账单金额`）。 | `INSERT INTO bills (...)`<br>`UPDATE reimbursement_lists SET total_amount=? WHERE list_id=?` | **必须使用数据库事务**，保证账单和清单金额同步。 |
| | **D2. 编辑/删除账单** | 1. 在账单表格行内提供操作按钮。<br>2. 编辑时为表单回填。 | 1. 校验操作人是账单支付人 (`payer_id`)。<br>2. **重新计算并更新清单总金额**。 | `UPDATE/DELETE FROM bills WHERE bill_id=?`<br>重算总额并更新清单。 | **事务操作**，涉及金额重算，逻辑比添加复杂。 |
| **E. 数据大盘** | **E1. 图表展示** | 1. 使用ECharts/ANTV等库渲染图表。<br>2. 布局：状态占比(饼图)、金额统计(卡片)。 | 1. 提供各个维度的统计聚合数据接口。<br>2. **所有数据查询必须限定 `creator_id = 当前用户ID`**。 | `SELECT activity_type, COUNT(*) FROM lists WHERE creator_id=? GROUP BY ...`<br>`SELECT status, COUNT(*) ...`<br>`SELECT SUM(total_amount) ...` | 基于用户数据的聚合查询，注意性能。 |
| | **E2. 数据筛选** | 1. 提供时间范围选择器（近7天/30天/自定义）。<br> | 1. 接口接收时间范围等筛选参数。<br>2. 在SQL的WHERE条件中动态加入时间过滤。 | `... WHERE creator_id=? AND create_time BETWEEN ? AND ?` | 日期查询需注意时区问题和索引使用。 |
| **F. 系统与公共** | **F1. 菜单/路由权限** | 1. 根据用户角色 (`role`) 动态生成侧边栏菜单。<br>2. “数据大盘”和“用户管理”页面按权限显示/隐藏。 | 1. 在登录接口或用户信息接口中返回用户角色。 | - | 前端路由守卫结合角色控制。 |
| | **F2. 数据接口权限** | - | 1. 所有业务接口（清单、账单、大盘）需在控制器/服务层校验 **当前用户ID 与 数据创建人ID** 是否匹配。<br>2. 管理员角色无权访问业务数据接口。 | - | **后端是权限校验的最后防线**，不能仅依赖前端。 |
| | **F3. 异常与日志** | 1. 统一的请求拦截器处理网络错误和业务错误。<br>2. 友好提示。 | 1. 全局异常处理中间件。<br>2. 记录关键操作日志（如登录、状态变更、删除）。 | 可考虑创建 `operation_logs` 表。 | 完善的错误处理机制。 |